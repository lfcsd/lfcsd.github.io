<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LFCSD Days Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
  body {
    margin: 0;
    padding: 0;
    font-family: 'Lexend', sans-serif;
    background: linear-gradient(135deg, #6a0dad, #8a2be2);
    color: white;
    min-height: 100vh;
  }

  .login-container, .admin-panel {
    max-width: 800px;
    margin: 50px auto;
    padding: 25px;
    border-radius: 12px;
    background: rgba(0,0,0,0.7);
  }

  h2 {
    border-bottom: 1px solid #8a2be2;
    padding-bottom: 10px;
  }

  .form-group {
    margin-bottom: 15px;
    text-align: left;
  }

  label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
  }

  input[type="email"],
  input[type="password"],
  input[type="text"],
  input[type="color"],
  textarea {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: none;
    background: rgba(255,255,255,0.1);
    color: white;
    font-size: 16px;
    margin-bottom: 10px;
  }

  input::placeholder,
  textarea::placeholder {
    color: rgba(255,255,255,0.7);
  }

  button {
    cursor: pointer;
    border: none;
    border-radius: 10px;
    padding: 12px 20px;
    transition: background 0.3s;
    font-size: 16px;
  }

  .login-btn { background: #8a2be2; color: white; width: 100%; }
  .login-btn:hover { background: #6a0dad; }

  .admin-btn { background: #8a2be2; color: white; margin: 5px; }
  .admin-btn:hover { background: #6a0dad; }

  .logout-btn { background: #ff6b6b; width: 100%; margin-top: 20px; }

  .announcement-preview, .notification-preview {
    margin-top: 15px;
    padding: 10px;
    border-radius: 10px;
    text-align: center;
    background: rgba(255,255,255,0.1);
  }

  .preview-content {
    padding: 12px;
    border-radius: 8px;
    font-weight: bold;
  }

  .apply-btn { background-color: #4CAF50; }
  .apply-btn:hover { background-color: #45a049; }
  .clear-btn { background-color: #f44336; }
  .clear-btn:hover { background-color: #da2c2c; }

</style>
</head>
<body>

<!-- Login -->
<div class="login-container" id="loginContainer">
  <h2>Admin Login</h2>
  <div id="errorMessage" style="color:#ff6b6b;"></div>
  <form id="loginForm">
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="email" placeholder="admin@example.com" required>
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="password" placeholder="Enter password" required>
    </div>
    <button type="submit" class="login-btn">Login</button>
  </form>
</div>

<!-- Admin Panel -->
<div class="admin-panel" id="adminPanel" style="display:none;">
  <!-- Day Controls -->
  <div class="admin-section">
    <h2>Today's Day Controls</h2>
    <button class="admin-btn" onclick="setDay('current',1)">Day 1</button>
    <button class="admin-btn" onclick="setDay('current',2)">Day 2</button>
    <button class="admin-btn" onclick="setSchedule('current','Half-Day')">Half-Day</button>
    <button class="admin-btn" onclick="setSchedule('current','2hr Delay')">2 Hour Delay</button>
    <button class="admin-btn" onclick="setSchedule('current','Regular Day')">Regular Day</button>
    <button class="admin-btn" onclick="resetAuto('current')">Reset to Auto</button>
  </div>

  <div class="admin-section">
    <h2>Next Day Controls</h2>
    <button class="admin-btn" onclick="setDay('next',1)">Day 1</button>
    <button class="admin-btn" onclick="setDay('next',2)">Day 2</button>
    <button class="admin-btn" onclick="setSchedule('next','Half-Day')">Half-Day</button>
    <button class="admin-btn" onclick="setSchedule('next','2hr Delay')">2 Hour Delay</button>
    <button class="admin-btn" onclick="setSchedule('next','Regular Day')">Regular Day</button>
    <button class="admin-btn" onclick="resetAuto('next')">Reset to Auto</button>
  </div>

  <!-- Announcements -->
  <div class="admin-section">
    <h2>Announcements</h2>
    <div class="form-group">
      <label>Message</label>
      <textarea id="announcementText" rows="3" placeholder="Enter announcement"></textarea>
    </div>
    <div class="form-group">
      <label>Background Color</label>
      <input type="color" id="colorPicker" value="#6a0dad">
      <input type="text" id="announcementColor" value="#6a0dad" placeholder="#6a0dad">
    </div>
    <button class="admin-btn apply-btn" onclick="setAnnouncement()">Apply Announcement</button>
    <button class="admin-btn clear-btn" onclick="clearAnnouncement()">Clear Announcement</button>
    <div class="announcement-preview">
      <div class="preview-content" id="announcementPreview">Preview announcement here</div>
    </div>
  </div>

  <!-- Push Notifications -->
  <div class="admin-section">
    <h2>Push Notifications</h2>
    <div class="form-group">
      <label>Title</label>
      <input type="text" id="notifTitle" placeholder="Notification title">
    </div>
    <div class="form-group">
      <label>Message</label>
      <textarea id="notifMessage" rows="3" placeholder="Notification message"></textarea>
    </div>
    <div class="form-group">
      <label>Icon URL</label>
      <input type="text" id="notifIcon" placeholder="Optional icon URL">
    </div>
    <div class="form-group">
      <label>Link URL</label>
      <input type="text" id="notifURL" placeholder="Optional click URL">
    </div>
    <button class="admin-btn apply-btn" onclick="sendPush()">Send Notification</button>
    <div class="notification-preview" id="notifPreview">Preview will appear here</div>
  </div>

  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyB6yxt2JX4ubnFsiYf2stfdnHeqjNySiJc",
    authDomain: "lfcsd-days.firebaseapp.com",
    projectId: "lfcsd-days",
    storageBucket: "lfcsd-days.appspot.com",
    messagingSenderId: "520576481150",
    appId: "1:520576481150:web:b08a50be7b0d15e113e52f"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Login
  document.getElementById('loginForm').addEventListener('submit', async e=>{
    e.preventDefault();
    try {
      const email=document.getElementById('email').value;
      const password=document.getElementById('password').value;
      const userCredential = await auth.signInWithEmailAndPassword(email,password);
      const token = await userCredential.user.getIdTokenResult();
      if(token.claims.admin){
        document.getElementById('loginContainer').style.display='none';
        document.getElementById('adminPanel').style.display='block';
        loadAnnouncement();
      } else throw new Error('Not an admin');
    } catch(err){
      document.getElementById('errorMessage').textContent=err.message;
      auth.signOut();
    }
  });

  auth.onAuthStateChanged(async user=>{
    if(user){
      const token = await user.getIdTokenResult();
      if(token.claims.admin){
        document.getElementById('loginContainer').style.display='none';
        document.getElementById('adminPanel').style.display='block';
        loadAnnouncement();
      }
    }
  });

  function logout(){ auth.signOut(); document.getElementById('loginContainer').style.display='block'; document.getElementById('adminPanel').style.display='none'; }

  // Settings
  async function updateSettings(updates, collection){
    await db.collection(collection).doc('current').update({...updates,lastUpdated:firebase.firestore.FieldValue.serverTimestamp()});
    alert("Updated successfully");
  }
  function setDay(type,day){ updateSettings({manualDay:day,autoMode:false},type==='current'?'settings':'nextDaySettings'); }
  function setSchedule(type,schedule){ updateSettings({schedule:schedule,autoMode:schedule==='Regular Day'},type==='current'?'settings':'nextDaySettings'); }
  function resetAuto(type){ updateSettings({manualDay:null,schedule:'Regular Day',autoMode:true},type==='current'?'settings':'nextDaySettings'); }

  // Announcements
  async function setAnnouncement(){
    const msg=document.getElementById('announcementText').value.trim();
    const color=document.getElementById('announcementColor').value||'#6a0dad';
    if(!msg){alert('Enter message'); return;}
    await db.collection('announcements').doc('current').set({message:msg,color:color,lastUpdated:firebase.firestore.FieldValue.serverTimestamp()});
    updateAnnouncementPreview();
    alert('Announcement set!');
  }
  async function clearAnnouncement(){
    await db.collection('announcements').doc('current').delete();
    document.getElementById('announcementText').value='';
    document.getElementById('announcementColor').value='#6a0dad';
    updateAnnouncementPreview();
  }
  function updateAnnouncementPreview(){
    const text=document.getElementById('announcementText').value;
    const color=document.getElementById('announcementColor').value;
    const preview=document.getElementById('announcementPreview');
    preview.textContent=text||'Preview announcement here';
    preview.style.backgroundColor=color||'#6a0dad';
  }
  async function loadAnnouncement(){
    const doc=await db.collection('announcements').doc('current').get();
    if(doc.exists){
      document.getElementById('announcementText').value=doc.data().message||'';
      document.getElementById('announcementColor').value=doc.data().color||'#6a0dad';
      updateAnnouncementPreview();
    }
  }

  // Push Notifications
  const publicVapidKey="BDCwJOe_9loznu0yeRBZoYhxg_LvzR5TA6ekWhQgTS6n9JvmrJWQdgZcSRw1OHswUSmnUV3VSo-FzrQtcCAl_5s";
  async function sendPush(){
    const title=document.getElementById('notifTitle').value;
    const message=document.getElementById('notifMessage').value;
    const icon=document.getElementById('notifIcon').value||'';
    const url=document.getElementById('notifURL').value||'';
    if(!title||!message){alert('Enter title & message'); return;}
    const snapshot=await db.collection('push_subscriptions').get();
    const subs=snapshot.docs.map(d=>d.data());
    for(const sub of subs){
      try{
        await fetch(sub.endpoint,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({title,message,icon,url,keys:sub.keys})
        });
      }catch(e){console.warn('Failed',e);}
    }
    document.getElementById('notifPreview').textContent=`Sent "${title}" to ${subs.length} subscribers`;
    alert(`Sent notification to ${subs.length} subscribers`);
  }

  document.getElementById('announcementText').addEventListener('input', updateAnnouncementPreview);
  document.getElementById('announcementColor').addEventListener('input', updateAnnouncementPreview);
</script>
</body>
</html>
